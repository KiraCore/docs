# [⏎](README.md#Roadmap) KIP_66
> Nodes Discovery

Nodes Discovery will be an INTERX feature enabling to visualize all nodes publicly exposed and not exposed to the internet and provide information on how they are interconnected with each other to provide clear understanding of the network layout and to spot potential vulnerabilities. To achieve this goal a new endpoint `/node_list` should be created that will return list of all KIRA nodes in the network and all relevant information about them.

In the INTERX configuration (and start arguments) a new `addrbook` property should be created defining location of the `addrbook.json` file which will be used to determine IP addresses that sentry and priv_sentry containers interact with. The `addrbook` property should be able to accept single file as well as multiple, comma separated files.

The `addrbook.json` is a file generated by containers running Tendermint and contains list of peers that those containers interact with.

Example content:

```
{
        "key": "4ccbed9f49199e20156d00b2",
        "addrs": [
                {
                        "addr": {
                                "id": "1661691970e85ef2052c7349b981e52a2e0677e7",
                                "ip": "172.31.23.138",
                                "port": 36656
                        },
                        "src": {
                                "id": "1661691970e85ef2052c7349b981e52a2e0677e7",
                                "ip": "172.31.23.138",
                                "port": 36656
                        },
                        "buckets": [
                                92,
                                133
                        ],
                        "attempts": 7,
                        "bucket_type": 1,
                        "last_attempt": "2021-03-22T19:41:41.326064567Z",
                        "last_success": "0001-01-01T00:00:00Z",
                        "last_ban_time": "0001-01-01T00:00:00Z"
                }, ...
        ]
}
```

Each `ip` address and a corresponding `port` within the `addrbook.json` is potentially a KIRA node. All IP addresses should be extracted from each addrbook json file for processing.

Endpoint `/api/status` should be extended with additional fields to contain all essential information's about the KIRA node:

Example of the new `/api/status` query response
```
{
  "interx_info": {
    "pub_key": {
      "type": "tendermint/PubKeySecp256k1",
      "value": "AtE7qevMJy0MzFtmWp0wWgUc3eD8sZEpcJYY+XsA1sZM"
    },
    "moniker": <string>,
    "kira_addr": <string>, // kira address (can be faucet or other key that INTERX owner might want to advertise as his)
    "genesis_checksum": <string>, // SHA256 hash
    "chain_id": <string>, // chain id of the network
    "version": <string>, // version of the release
    "sentry_node_id": <string> // node id of the sentry node (if present),
    "priv_sentry_node_id": <string> // node id of the priv sentry node (if present),
    "validator_node_id": <string> // node id of the validator node (if present),
    "seed_node_id": <string> // node id of the seed node (if present)
  }
}
```

Following information should be gathered from each KIRA node as result of `/pub_p2p_list` query:

```
"last_update": <integer>, // unix date time (start of scan process)
"scanning": <bool>, // if discovery is still running or not
"node_list": [ { 
    "id": <string>, // pub node_id
    "ip": <string>, // Public IP address
    "port": <integer>, // P2P port
    "ping": <integer>, // time in ms it took to dial P2P and verify P2P node_id
    "connected": <bool>, // is our node connected to this node
    "peers": [ <string>, .... ] // list of connected node_id's (connected set to true)
 }, { ... }, ... ]
```

To identify if IP address is public or a local IP following regex can be used:

```
^([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(?<!172\.(16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31))(?<!127)(?<!^10)(?<!^0)\.([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(?<!192\.168)(?<!172\.(16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31))\.([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(?<!\.255$)(?<!\b255.255.255.0\b)(?<!\b255.255.255.242\b)$
```

Following information should be gathered from each KIRA node as result of `/priv_p2p_list` query:

```
"last_update": <integer>, // unix date time (start of scan process)
"scanning": <bool>, // if discovery is still running or not
"node_list": [ { 
    "id": <string>, // priv node_id
    "ip": <string>, // Local IP address
    "port": <integer>, // P2P port
    "ping": <integer>, // time in ms it took to dial P2P and verify P2P node_id
    "connected": <bool>, // is our node connected to this node
    "peers": [ <string>, .... ] // list of connected nodes (node_id's)
 }, { ... }, ... ]
```

To determine location of INTERX nodes `/pub_p2p_list` of IP addresses should be used. If node is not included in the `pub_p2p_list` then it should NOT be present in the `/interx_list`. 

It is important that `interx_list` only contains verified data. This means that signature of the response from the `/api/status` must be checked.

Following information should be gathered from each KIRA node as the result of `/interx_list` query:

```
"last_update": <integer>, // unix date time (start of scan process)
"scanning": <bool>, // if discovery is still running or not
"node_list": [ { 
    "id": <string>, // pub_key (INTERX pub_key.value)
    "ip": <string>, // Public IP address
    "ping": <integer>, // time in ms it took to dial INTERX and verify pub_key
    "moniker": <string>, // set in INTERX config
    "faucet": <string>, // kira addr or null if faucet is not available
    "type": <string>, // node type set in INTERX config (validator, seed etc)
    "version": <string> // set in INTERX config
 }, { ... }, ... ]
```

To determine location of exposed snapshot nodes `/interx_list` of IP addresses should be used. If node is not included in the `interx_list` or is not exposing a snapshot then it should NOT be present in the `/snap_list`.

INTERX should be expanded with configuration allowing to define location of the snapshot. If the snapshot changes then the SHA256 checksum should be recalculated. It must also be configurable what is the total maximum upload and download speed of the INTERX node so that multiple connecting clients downloading snapshots or other data do NOT cause a DOS attack.

It is important that `snap_list` only contains verified data. This means that signature of the response from the `/api/status` must be checked.

Following information should be gathered from each KIRA node as the result of `/snap_list` query:

```
"last_update": <integer>, // unix date time (start of scan process)
"scanning": <bool>, // if discovery is still running or not
"node_list": [ { 
    "ip": <string>, // Public IP address
    "port": <integer>, // INTERX port
    "size": <string>, // size in Bytes
    "checksum": <string> // snapshot checksum (SHA256)
 }, { ... }, ... ]
```

## Notes

All IP addresses and `id`'s within all lists should be unique. Lists should be ordered by `ping` in ascending order or by `size` in descending order. Nodes that have `connected` flag set to true should have priority in the list.

Local node should always be a first entry in all of the list (unless it does not expose publicly certain functionalities such as INTERX or snapshot), then followed by other discovered entries. 

All lists should be recursively expanded by dialing public IP addresses present in the `interx_list`. 

All list endpoints should have option to only return comma separated list of `ip` addresses without any extra information as well as only list of connected addresses. For example: `/snap_list?connected=true&ip_only=true`

INTERX should have a configurable dial rate limit and a property allowing for defining maximum number of entries within each of the lists (default `8192`).

